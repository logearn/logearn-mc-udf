package cn.xlystar.parse.ammswap;

import cn.xlystar.entity.TransferEvent;
import cn.xlystar.helpers.ChainConfig;
import cn.xlystar.helpers.ConfigHelper;
import com.fasterxml.jackson.databind.JsonNode;

import java.io.IOException;
import java.util.List;
import java.util.Map;

public class AMMSwapDataProcess {
    public static String ZEROADDR = "0x0000000000000000000000000000000000000000".toLowerCase();

    public static List<Map<String, String>> decodeInputData(ChainConfig conf, String inputData, String from, String to, String value, String logs, String internalTxs, String hash) throws IOException {
        // 从内部交易中找到有效的交易，即：value>0的交易，且type = call
        List<TransferEvent> validInternalTxs = InternalTx.parseTx(internalTxs, conf.getWCoinAddress());
        // 从logs中解析swap
        List<Map<String, String>> maps = AMMSwapDataProcessFull.parseFullUniswap(conf, logs, hash, validInternalTxs);
//        for (int i = 0, len = maps.size(); i < len; i++) {
//            Map<String, String> t = maps.get(i);
//            if (t.get("errorMsg") != null || t.get("tokenIn") == null || t.get("tokenOut") == null) {
//                maps.remove(i);
//                len--;
//                i--;
//            }
//        }
        return maps;
    }

    public static List<Map<String, String>> decodeInputData(ChainConfig conf, String logs, String internalTxs, String hash) throws IOException {
        return decodeInputData(conf, "", "", "", "", logs, internalTxs, hash);
    }

    public static void main(String[] args) throws IOException {
        String logs = "{\"logs\":[{\"address\":\"0x23b530268c4a1f0bb11fbb0aa2f3ddf0d41caf22\",\"data\":\"0x00000000000000000017cf004747484848484848484848484848484848484848\",\"logindex\":\"0x19\",\"topics\":[]},{\"address\":\"0x60a39010e4892b862d1bb6bdde908215ac5af6f3\",\"data\":\"0x0000000000000000000000000000000000000000000000000c243ebda8f06d100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000012a8fb5c296c2cee015400\",\"logindex\":\"0x27\",\"topics\":[\"0xd78ad95fa46c994b6551d0da85fc275fe613ce37657fb8d5e3d130840159d822\",\"0x00000000000000000000000023b530268c4a1f0bb11fbb0aa2f3ddf0d41caf22\",\"0x00000000000000000000000023b530268c4a1f0bb11fbb0aa2f3ddf0d41caf22\"]},{\"address\":\"0x60a39010e4892b862d1bb6bdde908215ac5af6f3\",\"data\":\"0x0000000000000000000000000000000000000000000000011f690ffdfbdd4a7a000000000000000000000000000000000000000001a853983f0cd4f2fdfe56c7\",\"logindex\":\"0x26\",\"topics\":[\"0x1c411e9a96e071241c2f21f7726b17ae89e3cab4c78be50e062b03a9fffbbad1\"]},{\"address\":\"0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\",\"data\":\"0x00000000000000000000000000000000000000000000000000b0ce6de1d266c8\",\"logindex\":\"0x28\",\"topics\":[\"0x7fcf532c15f0a6db0bd6d0e038bea71d30d808c7d98cb3bf7268a95bf5081b65\",\"0x00000000000000000000000023b530268c4a1f0bb11fbb0aa2f3ddf0d41caf22\"]},{\"address\":\"0x16b70f44719b227278a2dc1122e8106cc929ecd1\",\"data\":\"0xfffffffffffffffffffffffffffffffffffffffffffffffff31a731a735b36cf00000000000000000000000000000000000000000012a8fb5c296c2cee01540000000000000000000000000000000000000013510125d418e7f184595084111300000000000000000000000000000000000000000000378badb59a205b2c451b0000000000000000000000000000000000000000000000000000000000029893\",\"logindex\":\"0x24\",\"topics\":[\"0xc42079f94a6350d7e6235f29174924f928cc2ac818eb64fed8004e115fbcca67\",\"0x00000000000000000000000023b530268c4a1f0bb11fbb0aa2f3ddf0d41caf22\",\"0x00000000000000000000000023b530268c4a1f0bb11fbb0aa2f3ddf0d41caf22\"]},{\"address\":\"0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\",\"data\":\"0x0000000000000000000000000000000000000000000000000ce58ce58ca4c931\",\"logindex\":\"0x22\",\"topics\":[\"0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef\",\"0x00000000000000000000000016b70f44719b227278a2dc1122e8106cc929ecd1\",\"0x00000000000000000000000023b530268c4a1f0bb11fbb0aa2f3ddf0d41caf22\"]},{\"address\":\"0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\",\"data\":\"0x0000000000000000000000000000000000000000000000000c243ebda8f06d10\",\"logindex\":\"0x25\",\"topics\":[\"0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef\",\"0x00000000000000000000000023b530268c4a1f0bb11fbb0aa2f3ddf0d41caf22\",\"0x00000000000000000000000060a39010e4892b862d1bb6bdde908215ac5af6f3\"]},{\"address\":\"0xd2877702675e6ceb975b4a1dff9fb7baf4c91ea9\",\"data\":\"0x00000000000000000000000000000000000000000012a8fb5c296c2cee015400\",\"logindex\":\"0x23\",\"topics\":[\"0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef\",\"0x00000000000000000000000023b530268c4a1f0bb11fbb0aa2f3ddf0d41caf22\",\"0x00000000000000000000000016b70f44719b227278a2dc1122e8106cc929ecd1\"]},{\"address\":\"0x23b530268c4a1f0bb11fbb0aa2f3ddf0d41caf22\",\"data\":\"0x0000000000000000000000000000000000000000000000000000000000000048\",\"logindex\":\"0x1f\",\"topics\":[]},{\"address\":\"0xd2877702675e6ceb975b4a1dff9fb7baf4c91ea9\",\"data\":\"0x00000000000000000000000000000000000000000012a8fb5c296c2cee015400\",\"logindex\":\"0x21\",\"topics\":[\"0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef\",\"0x00000000000000000000000060a39010e4892b862d1bb6bdde908215ac5af6f3\",\"0x00000000000000000000000023b530268c4a1f0bb11fbb0aa2f3ddf0d41caf22\"]},{\"address\":\"0x23b530268c4a1f0bb11fbb0aa2f3ddf0d41caf22\",\"data\":\"0x0000000000000000000000000000000000000000000000000000000000000000\",\"logindex\":\"0x20\",\"topics\":[]},{\"address\":\"0x23b530268c4a1f0bb11fbb0aa2f3ddf0d41caf22\",\"data\":\"0x0000000000000000000000000000000000000000000000000000000000000000\",\"logindex\":\"0x1c\",\"topics\":[]},{\"address\":\"0x23b530268c4a1f0bb11fbb0aa2f3ddf0d41caf22\",\"data\":\"0x0000000000000000000000000000000000000000000000000000000000000001\",\"logindex\":\"0x1d\",\"topics\":[]},{\"address\":\"0x23b530268c4a1f0bb11fbb0aa2f3ddf0d41caf22\",\"data\":\"0x0000000000000000000000000000000000000000000000000000000000000002\",\"logindex\":\"0x1e\",\"topics\":[]},{\"address\":\"0x23b530268c4a1f0bb11fbb0aa2f3ddf0d41caf22\",\"data\":\"0x0000000000000000000000000000000000000000000000000000000000000017\",\"logindex\":\"0x1a\",\"topics\":[]},{\"address\":\"0x23b530268c4a1f0bb11fbb0aa2f3ddf0d41caf22\",\"data\":\"0x00000000000000000000000000000000000000000000000000000000000000cf\",\"logindex\":\"0x1b\",\"topics\":[]}]}";
        String interTx = "[{\"action\":{\"from\":\"0x23b530268c4a1f0bb11fbb0aa2f3ddf0d41caf22\",\"to\":\"0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\",\"input\":\"0x70a0823100000000000000000000000023b530268c4a1f0bb11fbb0aa2f3ddf0d41caf22\",\"value\":\"0x0\",\"calltype\":\"call\"}},{\"action\":{\"from\":\"0x23b530268c4a1f0bb11fbb0aa2f3ddf0d41caf22\",\"to\":\"0xd2877702675e6ceb975b4a1dff9fb7baf4c91ea9\",\"input\":\"0x70a0823100000000000000000000000060a39010e4892b862d1bb6bdde908215ac5af6f3\",\"value\":\"0x0\",\"calltype\":\"call\"}},{\"action\":{\"from\":\"0x23b530268c4a1f0bb11fbb0aa2f3ddf0d41caf22\",\"to\":\"0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\",\"input\":\"0x70a0823100000000000000000000000023b530268c4a1f0bb11fbb0aa2f3ddf0d41caf22\",\"value\":\"0x0\",\"calltype\":\"call\"}},{\"action\":{\"from\":\"0x23b530268c4a1f0bb11fbb0aa2f3ddf0d41caf22\",\"to\":\"0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\",\"input\":\"0xa9059cbb00000000000000000000000060a39010e4892b862d1bb6bdde908215ac5af6f30000000000000000000000000000000000000000000000000c243ebda8f06d10\",\"value\":\"0x0\",\"calltype\":\"call\"}},{\"action\":{\"from\":\"0x23b530268c4a1f0bb11fbb0aa2f3ddf0d41caf22\",\"to\":\"0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\",\"input\":\"0x70a0823100000000000000000000000023b530268c4a1f0bb11fbb0aa2f3ddf0d41caf22\",\"value\":\"0x0\",\"calltype\":\"call\"}},{\"action\":{\"from\":\"0xf288e8d5466db4e040626ae288a6fc036b87cb88\",\"to\":\"0x23b530268c4a1f0bb11fbb0aa2f3ddf0d41caf22\",\"input\":\"0x000000001400010063000100b8010c00000000000000012493fe0c111e2ea5c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000001a0b46edfb767dd08f2fac7d2877702675e6ceb975b4a1dff9fb7baf4c91ea960a39010e4892b862d1bb6bdde908215ac5af6f3120500484d505355565758595a5a5b5b5c5c5d5d5d5d5e17cf0047474848484848484848484848484848484848480001002800100000000000000000000000000000000116b70f44719b227278a2dc1122e8106cc929ecd1\",\"value\":\"0x0\",\"calltype\":\"call\"}},{\"action\":{\"from\":\"0x16b70f44719b227278a2dc1122e8106cc929ecd1\",\"to\":\"0x23b530268c4a1f0bb11fbb0aa2f3ddf0d41caf22\",\"input\":\"0xfa461e33fffffffffffffffffffffffffffffffffffffffffffffffff31a731a735b36cf00000000000000000000000000000000000000000012a8fb5c296c2cee01540000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000\",\"value\":\"0x0\",\"calltype\":\"call\"}},{\"action\":{\"from\":\"0x23b530268c4a1f0bb11fbb0aa2f3ddf0d41caf22\",\"to\":\"0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\",\"input\":\"0x2e1a7d4d00000000000000000000000000000000000000000000000000b0ce6de1d266c8\",\"value\":\"0x0\",\"calltype\":\"call\"}},{\"action\":{\"from\":\"0x23b530268c4a1f0bb11fbb0aa2f3ddf0d41caf22\",\"to\":\"0x45d9809b054b380ecdb29a6b2674c36addbfac93\",\"input\":\"0x000000001400010063000100b8010c00000000000000012493fe0c111e2ea5c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000001a0b46edfb767dd08f2fac7d2877702675e6ceb975b4a1dff9fb7baf4c91ea960a39010e4892b862d1bb6bdde908215ac5af6f3120500484d505355565758595a5a5b5b5c5c5d5d5d5d5e17cf0047474848484848484848484848484848484848480001002800100000000000000000000000000000000116b70f44719b227278a2dc1122e8106cc929ecd1\",\"value\":\"0x0\",\"calltype\":\"delegatecall\"}},{\"action\":{\"from\":\"0x16b70f44719b227278a2dc1122e8106cc929ecd1\",\"to\":\"0xd2877702675e6ceb975b4a1dff9fb7baf4c91ea9\",\"input\":\"0x70a0823100000000000000000000000016b70f44719b227278a2dc1122e8106cc929ecd1\",\"value\":\"0x0\",\"calltype\":\"staticcall\"}},{\"action\":{\"from\":\"0x60a39010e4892b862d1bb6bdde908215ac5af6f3\",\"to\":\"0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\",\"input\":\"0x70a0823100000000000000000000000060a39010e4892b862d1bb6bdde908215ac5af6f3\",\"value\":\"0x0\",\"calltype\":\"staticcall\"}},{\"action\":{\"from\":\"0x60a39010e4892b862d1bb6bdde908215ac5af6f3\",\"to\":\"0xd2877702675e6ceb975b4a1dff9fb7baf4c91ea9\",\"input\":\"0x70a0823100000000000000000000000060a39010e4892b862d1bb6bdde908215ac5af6f3\",\"value\":\"0x0\",\"calltype\":\"staticcall\"}},{\"action\":{\"from\":\"0x16b70f44719b227278a2dc1122e8106cc929ecd1\",\"to\":\"0xd2877702675e6ceb975b4a1dff9fb7baf4c91ea9\",\"input\":\"0x70a0823100000000000000000000000016b70f44719b227278a2dc1122e8106cc929ecd1\",\"value\":\"0x0\",\"calltype\":\"staticcall\"}},{\"action\":{\"from\":\"0x23b530268c4a1f0bb11fbb0aa2f3ddf0d41caf22\",\"to\":\"0x45d9809b054b380ecdb29a6b2674c36addbfac93\",\"input\":\"0x10d1e85c00000000000000000000000023b530268c4a1f0bb11fbb0aa2f3ddf0d41caf22000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000012a8fb5c296c2cee0154000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000002a0001002800100000000000000000000000000000000116b70f44719b227278a2dc1122e8106cc929ecd100000000000000000000000000000000000000000000\",\"value\":\"0x0\",\"calltype\":\"delegatecall\"}},{\"action\":{\"from\":\"0x23b530268c4a1f0bb11fbb0aa2f3ddf0d41caf22\",\"to\":\"0x45d9809b054b380ecdb29a6b2674c36addbfac93\",\"input\":\"0xfa461e33fffffffffffffffffffffffffffffffffffffffffffffffff31a731a735b36cf00000000000000000000000000000000000000000012a8fb5c296c2cee01540000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000\",\"value\":\"0x0\",\"calltype\":\"delegatecall\"}},{\"action\":{\"from\":\"0x23b530268c4a1f0bb11fbb0aa2f3ddf0d41caf22\",\"to\":\"0x16b70f44719b227278a2dc1122e8106cc929ecd1\",\"input\":\"0x128acb0800000000000000000000000023b530268c4a1f0bb11fbb0aa2f3ddf0d41caf22000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000012a8fb5c296c2cee015400000000000000000000000000fffd8963efd1fc6a506488495d951d5263988d2500000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000000\",\"value\":\"0x0\",\"calltype\":\"call\"}},{\"action\":{\"from\":\"0x23b530268c4a1f0bb11fbb0aa2f3ddf0d41caf22\",\"to\":\"0x60a39010e4892b862d1bb6bdde908215ac5af6f3\",\"input\":\"0x022c0d9f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000012a8fb5c296c2cee01540000000000000000000000000023b530268c4a1f0bb11fbb0aa2f3ddf0d41caf220000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000002a0001002800100000000000000000000000000000000116b70f44719b227278a2dc1122e8106cc929ecd100000000000000000000000000000000000000000000\",\"value\":\"0x0\",\"calltype\":\"call\"}},{\"action\":{\"from\":\"0x60a39010e4892b862d1bb6bdde908215ac5af6f3\",\"to\":\"0x23b530268c4a1f0bb11fbb0aa2f3ddf0d41caf22\",\"input\":\"0x10d1e85c00000000000000000000000023b530268c4a1f0bb11fbb0aa2f3ddf0d41caf22000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000012a8fb5c296c2cee0154000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000002a0001002800100000000000000000000000000000000116b70f44719b227278a2dc1122e8106cc929ecd100000000000000000000000000000000000000000000\",\"value\":\"0x0\",\"calltype\":\"call\"}},{\"action\":{\"from\":\"0x23b530268c4a1f0bb11fbb0aa2f3ddf0d41caf22\",\"to\":\"0x4838b106fce9647bdf1e7877bf73ce8b0bad5f97\",\"input\":\"0x\",\"value\":\"0xb0ce6de1d266c8\",\"calltype\":\"call\"}},{\"action\":{\"from\":\"0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\",\"to\":\"0x23b530268c4a1f0bb11fbb0aa2f3ddf0d41caf22\",\"input\":\"0x\",\"value\":\"0xb0ce6de1d266c8\",\"calltype\":\"call\"}},{\"action\":{\"from\":\"0x23b530268c4a1f0bb11fbb0aa2f3ddf0d41caf22\",\"to\":\"0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\",\"input\":\"0x70a0823100000000000000000000000023b530268c4a1f0bb11fbb0aa2f3ddf0d41caf22\",\"value\":\"0x0\",\"calltype\":\"call\"}},{\"action\":{\"from\":\"0x23b530268c4a1f0bb11fbb0aa2f3ddf0d41caf22\",\"to\":\"0xd2877702675e6ceb975b4a1dff9fb7baf4c91ea9\",\"input\":\"0xa9059cbb00000000000000000000000016b70f44719b227278a2dc1122e8106cc929ecd100000000000000000000000000000000000000000012a8fb5c296c2cee015400\",\"value\":\"0x0\",\"calltype\":\"call\"}},{\"action\":{\"from\":\"0x23b530268c4a1f0bb11fbb0aa2f3ddf0d41caf22\",\"to\":\"0x16b70f44719b227278a2dc1122e8106cc929ecd1\",\"input\":\"0x0dfe1681\",\"value\":\"0x0\",\"calltype\":\"call\"}},{\"action\":{\"from\":\"0x23b530268c4a1f0bb11fbb0aa2f3ddf0d41caf22\",\"to\":\"0x16b70f44719b227278a2dc1122e8106cc929ecd1\",\"input\":\"0xd21220a7\",\"value\":\"0x0\",\"calltype\":\"call\"}},{\"action\":{\"from\":\"0x16b70f44719b227278a2dc1122e8106cc929ecd1\",\"to\":\"0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\",\"input\":\"0xa9059cbb00000000000000000000000023b530268c4a1f0bb11fbb0aa2f3ddf0d41caf220000000000000000000000000000000000000000000000000ce58ce58ca4c931\",\"value\":\"0x0\",\"calltype\":\"call\"}},{\"action\":{\"from\":\"0x23b530268c4a1f0bb11fbb0aa2f3ddf0d41caf22\",\"to\":\"0x60a39010e4892b862d1bb6bdde908215ac5af6f3\",\"input\":\"0x0902f1ac\",\"value\":\"0x0\",\"calltype\":\"call\"}},{\"action\":{\"from\":\"0x23b530268c4a1f0bb11fbb0aa2f3ddf0d41caf22\",\"to\":\"0x60a39010e4892b862d1bb6bdde908215ac5af6f3\",\"input\":\"0x0dfe1681\",\"value\":\"0x0\",\"calltype\":\"call\"}},{\"action\":{\"from\":\"0x23b530268c4a1f0bb11fbb0aa2f3ddf0d41caf22\",\"to\":\"0x60a39010e4892b862d1bb6bdde908215ac5af6f3\",\"input\":\"0xd21220a7\",\"value\":\"0x0\",\"calltype\":\"call\"}},{\"action\":{\"from\":\"0x60a39010e4892b862d1bb6bdde908215ac5af6f3\",\"to\":\"0xd2877702675e6ceb975b4a1dff9fb7baf4c91ea9\",\"input\":\"0xa9059cbb00000000000000000000000023b530268c4a1f0bb11fbb0aa2f3ddf0d41caf2200000000000000000000000000000000000000000012a8fb5c296c2cee015400\",\"value\":\"0x0\",\"calltype\":\"call\"}},{\"action\":{\"from\":\"0x23b530268c4a1f0bb11fbb0aa2f3ddf0d41caf22\",\"to\":\"0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\",\"input\":\"0x70a0823100000000000000000000000060a39010e4892b862d1bb6bdde908215ac5af6f3\",\"value\":\"0x0\",\"calltype\":\"call\"}}]";


        String hash = "0xa1a3f100f08d6eb1c723e682a95ef0625ee52dd0e01bd50b2cd247813e91d398";
        ConfigHelper configHelper = new ConfigHelper();
        ChainConfig config = configHelper.getConfig("1", "uniswap");
        System.out.println(decodeInputData(config, logs, interTx, hash));
    }
}

