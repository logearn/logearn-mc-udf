package cn.xlystar.parse.ammswap;

import cn.xlystar.entity.TransferEvent;
import cn.xlystar.helpers.ChainConfig;
import cn.xlystar.helpers.ConfigHelper;
import com.fasterxml.jackson.databind.JsonNode;

import java.io.IOException;
import java.util.List;
import java.util.Map;

public class AMMSwapDataProcess {
    public static String ZEROADDR = "0x0000000000000000000000000000000000000000".toLowerCase();

    public static List<Map<String, String>> decodeInputData(ChainConfig conf, String inputData, String from, String to, String value, String logs, String internalTxs, String hash) throws IOException {
        // 从内部交易中找到有效的交易，即：value>0的交易，且type = call
        List<TransferEvent> validInternalTxs = InternalTx.parseTx(internalTxs, conf.getWCoinAddress());
        // 从logs中解析swap
        List<Map<String, String>> maps = AMMSwapDataProcessFull.parseFullUniswap(conf, logs, hash, validInternalTxs);
//        for (int i = 0, len = maps.size(); i < len; i++) {
//            Map<String, String> t = maps.get(i);
//            if (t.get("errorMsg") != null || t.get("tokenIn") == null || t.get("tokenOut") == null) {
//                maps.remove(i);
//                len--;
//                i--;
//            }
//        }
        return maps;
    }

    public static List<Map<String, String>> decodeInputData(ChainConfig conf, String logs, String internalTxs, String hash) throws IOException {
        return decodeInputData(conf, "", "", "", "", logs, internalTxs, hash);
    }

    public static void main(String[] args) throws IOException {
        String logs = "{\"logs\":[{\"address\":\"0x1d2fc977cc1e1fbd57a8b7f81fcd5d541d8531dd\",\"data\":\"0x\",\"logindex\":\"0xa1\",\"topics\":[\"0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef\",\"0x000000000000000000000000aa2a0961e2e6b7229d813091de39abda94ada0ae\",\"0x0000000000000000000000000b2680ed2ef5202c686af9fdd996ab7f857ecce3\",\"0x000000000000000000000000000000000000000000000000000000000000031d\"]},{\"address\":\"0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\",\"data\":\"0x0000000000000000000000000000000000000000000000000000047f15a694b3\",\"logindex\":\"0xa3\",\"topics\":[\"0x7fcf532c15f0a6db0bd6d0e038bea71d30d808c7d98cb3bf7268a95bf5081b65\",\"0x00000000000000000000000080a64c6d7f12c47b7c66c5b4e20e72bc1fcd5d9e\"]},{\"address\":\"0x0b2680ed2ef5202c686af9fdd996ab7f857ecce3\",\"data\":\"0x000000000000000000000000000000000000000000000000000000000000031dfffffffffffffffffffffffffffffffffffffffffffffffffffffb80ea596b4d00000000000000000000000000000000000135360998614ec7fc875738f025820000000000000000000000000000000000000000000000000001c39d78033be4000000000000000000000000000000000000000000000000000000000003713b\",\"logindex\":\"0xa2\",\"topics\":[\"0xc42079f94a6350d7e6235f29174924f928cc2ac818eb64fed8004e115fbcca67\",\"0x00000000000000000000000080a64c6d7f12c47b7c66c5b4e20e72bc1fcd5d9e\",\"0x00000000000000000000000080a64c6d7f12c47b7c66c5b4e20e72bc1fcd5d9e\"]},{\"address\":\"0x000000000022d473030f116ddee9f6b43ac78ba3\",\"data\":\"0x000000000000000000000000000000000000000000000000000000000000031d0000000000000000000000000000000000000000000000000000000065e350260000000000000000000000000000000000000000000000000000000000000001\",\"logindex\":\"0x9f\",\"topics\":[\"0xc6a377bfc4eb120024a8ac08eef205be16b817020812c73223e81d1bdb9708ec\",\"0x000000000000000000000000aa2a0961e2e6b7229d813091de39abda94ada0ae\",\"0x0000000000000000000000001d2fc977cc1e1fbd57a8b7f81fcd5d541d8531dd\",\"0x00000000000000000000000080a64c6d7f12c47b7c66c5b4e20e72bc1fcd5d9e\"]},{\"address\":\"0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\",\"data\":\"0x0000000000000000000000000000000000000000000000000000047f15a694b3\",\"logindex\":\"0xa0\",\"topics\":[\"0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef\",\"0x0000000000000000000000000b2680ed2ef5202c686af9fdd996ab7f857ecce3\",\"0x00000000000000000000000080a64c6d7f12c47b7c66c5b4e20e72bc1fcd5d9e\"]}]}";
        String interTx = "[{\"action\":{\"from\":\"0x80a64c6d7f12c47b7c66c5b4e20e72bc1fcd5d9e\",\"to\":\"0x000000000022d473030f116ddee9f6b43ac78ba3\",\"input\":\"0x2b67b570000000000000000000000000aa2a0961e2e6b7229d813091de39abda94ada0ae0000000000000000000000001d2fc977cc1e1fbd57a8b7f81fcd5d541d8531dd000000000000000000000000000000000000000000000000000000000000031d0000000000000000000000000000000000000000000000000000000065e35026000000000000000000000000000000000000000000000000000000000000000100000000000000000000000080a64c6d7f12c47b7c66c5b4e20e72bc1fcd5d9e0000000000000000000000000000000000000000000000000000000065e35026000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000413c0429ecb8d9f5fcc60f4003abcaea8fff90a2ac19af5fef3ef814d4750a96ea2cd2697ee081d6f34fc844817bafd4fa7e6d55a77e5108d0435680d54bca38cc1b00000000000000000000000000000000000000000000000000000000000000\",\"value\":\"0x0\",\"calltype\":\"call\"}},{\"action\":{\"from\":\"0x000000000022d473030f116ddee9f6b43ac78ba3\",\"to\":\"0x1d2fc977cc1e1fbd57a8b7f81fcd5d541d8531dd\",\"input\":\"0x23b872dd000000000000000000000000aa2a0961e2e6b7229d813091de39abda94ada0ae0000000000000000000000000b2680ed2ef5202c686af9fdd996ab7f857ecce3000000000000000000000000000000000000000000000000000000000000031d\",\"value\":\"0x0\",\"calltype\":\"call\"}},{\"action\":{\"from\":\"0x80a64c6d7f12c47b7c66c5b4e20e72bc1fcd5d9e\",\"to\":\"0xaa2a0961e2e6b7229d813091de39abda94ada0ae\",\"input\":\"0x\",\"value\":\"0x47f15a694b3\",\"calltype\":\"call\"}},{\"action\":{\"from\":\"0xaa2a0961e2e6b7229d813091de39abda94ada0ae\",\"to\":\"0x80a64c6d7f12c47b7c66c5b4e20e72bc1fcd5d9e\",\"input\":\"0x3593564c000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000065bbca3800000000000000000000000000000000000000000000000000000000000000040a000c04000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000320000000000000000000000000000000000000000000000000000000000000038000000000000000000000000000000000000000000000000000000000000001600000000000000000000000001d2fc977cc1e1fbd57a8b7f81fcd5d541d8531dd000000000000000000000000000000000000000000000000000000000000031d0000000000000000000000000000000000000000000000000000000065e35026000000000000000000000000000000000000000000000000000000000000000100000000000000000000000080a64c6d7f12c47b7c66c5b4e20e72bc1fcd5d9e0000000000000000000000000000000000000000000000000000000065e3502600000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000413c0429ecb8d9f5fcc60f4003abcaea8fff90a2ac19af5fef3ef814d4750a96ea2cd2697ee081d6f34fc844817bafd4fa7e6d55a77e5108d0435680d54bca38cc1b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000031d00000000000000000000000000000000000000000000000000000234080c812e00000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002b1d2fc977cc1e1fbd57a8b7f81fcd5d541d8531dd002710c02aaa39b223fe8d0a0e5c4f27ead9083c756cc200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000001d2fc977cc1e1fbd57a8b7f81fcd5d541d8531dd00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000\",\"value\":\"0x0\",\"calltype\":\"call\"}},{\"action\":{\"from\":\"0x0b2680ed2ef5202c686af9fdd996ab7f857ecce3\",\"to\":\"0x80a64c6d7f12c47b7c66c5b4e20e72bc1fcd5d9e\",\"input\":\"0xfa461e33000000000000000000000000000000000000000000000000000000000000031dfffffffffffffffffffffffffffffffffffffffffffffffffffffb80ea596b4d000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000040000000000000000000000000aa2a0961e2e6b7229d813091de39abda94ada0ae000000000000000000000000000000000000000000000000000000000000002b1d2fc977cc1e1fbd57a8b7f81fcd5d541d8531dd002710c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000000000000000000000\",\"value\":\"0x0\",\"calltype\":\"call\"}},{\"action\":{\"from\":\"0x80a64c6d7f12c47b7c66c5b4e20e72bc1fcd5d9e\",\"to\":\"0x000000000022d473030f116ddee9f6b43ac78ba3\",\"input\":\"0x36c78516000000000000000000000000aa2a0961e2e6b7229d813091de39abda94ada0ae0000000000000000000000000b2680ed2ef5202c686af9fdd996ab7f857ecce3000000000000000000000000000000000000000000000000000000000000031d0000000000000000000000001d2fc977cc1e1fbd57a8b7f81fcd5d541d8531dd\",\"value\":\"0x0\",\"calltype\":\"call\"}},{\"action\":{\"from\":\"0x80a64c6d7f12c47b7c66c5b4e20e72bc1fcd5d9e\",\"to\":\"0x6599ae06914f1f5ec0053d3f475348d40e608442\",\"input\":\"0xfa461e33000000000000000000000000000000000000000000000000000000000000031dfffffffffffffffffffffffffffffffffffffffffffffffffffffb80ea596b4d000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000040000000000000000000000000aa2a0961e2e6b7229d813091de39abda94ada0ae000000000000000000000000000000000000000000000000000000000000002b1d2fc977cc1e1fbd57a8b7f81fcd5d541d8531dd002710c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000000000000000000000\",\"value\":\"0x0\",\"calltype\":\"delegatecall\"}},{\"action\":{\"from\":\"0x0b2680ed2ef5202c686af9fdd996ab7f857ecce3\",\"to\":\"0x1d2fc977cc1e1fbd57a8b7f81fcd5d541d8531dd\",\"input\":\"0x70a082310000000000000000000000000b2680ed2ef5202c686af9fdd996ab7f857ecce3\",\"value\":\"0x0\",\"calltype\":\"staticcall\"}},{\"action\":{\"from\":\"0x0b2680ed2ef5202c686af9fdd996ab7f857ecce3\",\"to\":\"0x1d2fc977cc1e1fbd57a8b7f81fcd5d541d8531dd\",\"input\":\"0x70a082310000000000000000000000000b2680ed2ef5202c686af9fdd996ab7f857ecce3\",\"value\":\"0x0\",\"calltype\":\"staticcall\"}},{\"action\":{\"from\":\"0x80a64c6d7f12c47b7c66c5b4e20e72bc1fcd5d9e\",\"to\":\"0x1d2fc977cc1e1fbd57a8b7f81fcd5d541d8531dd\",\"input\":\"0x70a0823100000000000000000000000080a64c6d7f12c47b7c66c5b4e20e72bc1fcd5d9e\",\"value\":\"0x0\",\"calltype\":\"staticcall\"}},{\"action\":{\"from\":\"0x0b2680ed2ef5202c686af9fdd996ab7f857ecce3\",\"to\":\"0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\",\"input\":\"0xa9059cbb00000000000000000000000080a64c6d7f12c47b7c66c5b4e20e72bc1fcd5d9e0000000000000000000000000000000000000000000000000000047f15a694b3\",\"value\":\"0x0\",\"calltype\":\"call\"}},{\"action\":{\"from\":\"0x80a64c6d7f12c47b7c66c5b4e20e72bc1fcd5d9e\",\"to\":\"0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\",\"input\":\"0x2e1a7d4d0000000000000000000000000000000000000000000000000000047f15a694b3\",\"value\":\"0x0\",\"calltype\":\"call\"}},{\"action\":{\"from\":\"0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\",\"to\":\"0x80a64c6d7f12c47b7c66c5b4e20e72bc1fcd5d9e\",\"input\":\"0x\",\"value\":\"0x47f15a694b3\",\"calltype\":\"call\"}},{\"action\":{\"from\":\"0x80a64c6d7f12c47b7c66c5b4e20e72bc1fcd5d9e\",\"to\":\"0x0b2680ed2ef5202c686af9fdd996ab7f857ecce3\",\"input\":\"0x128acb0800000000000000000000000080a64c6d7f12c47b7c66c5b4e20e72bc1fcd5d9e0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000031d00000000000000000000000000000000000000000000000000000001000276a400000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000040000000000000000000000000aa2a0961e2e6b7229d813091de39abda94ada0ae000000000000000000000000000000000000000000000000000000000000002b1d2fc977cc1e1fbd57a8b7f81fcd5d541d8531dd002710c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000000000000000000000\",\"value\":\"0x0\",\"calltype\":\"call\"}},{\"action\":{\"from\":\"0x80a64c6d7f12c47b7c66c5b4e20e72bc1fcd5d9e\",\"to\":\"0x6599ae06914f1f5ec0053d3f475348d40e608442\",\"input\":\"0x\",\"value\":\"0x47f15a694b3\",\"calltype\":\"delegatecall\"}},{\"action\":{\"from\":\"0x80a64c6d7f12c47b7c66c5b4e20e72bc1fcd5d9e\",\"to\":\"0x6599ae06914f1f5ec0053d3f475348d40e608442\",\"input\":\"0x3593564c000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000065bbca3800000000000000000000000000000000000000000000000000000000000000040a000c04000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000320000000000000000000000000000000000000000000000000000000000000038000000000000000000000000000000000000000000000000000000000000001600000000000000000000000001d2fc977cc1e1fbd57a8b7f81fcd5d541d8531dd000000000000000000000000000000000000000000000000000000000000031d0000000000000000000000000000000000000000000000000000000065e35026000000000000000000000000000000000000000000000000000000000000000100000000000000000000000080a64c6d7f12c47b7c66c5b4e20e72bc1fcd5d9e0000000000000000000000000000000000000000000000000000000065e3502600000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000413c0429ecb8d9f5fcc60f4003abcaea8fff90a2ac19af5fef3ef814d4750a96ea2cd2697ee081d6f34fc844817bafd4fa7e6d55a77e5108d0435680d54bca38cc1b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000031d00000000000000000000000000000000000000000000000000000234080c812e00000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002b1d2fc977cc1e1fbd57a8b7f81fcd5d541d8531dd002710c02aaa39b223fe8d0a0e5c4f27ead9083c756cc200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000001d2fc977cc1e1fbd57a8b7f81fcd5d541d8531dd00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000\",\"value\":\"0x0\",\"calltype\":\"delegatecall\"}},{\"action\":{\"from\":\"0x80a64c6d7f12c47b7c66c5b4e20e72bc1fcd5d9e\",\"to\":\"0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\",\"input\":\"0x70a0823100000000000000000000000080a64c6d7f12c47b7c66c5b4e20e72bc1fcd5d9e\",\"value\":\"0x0\",\"calltype\":\"staticcall\"}}]";

        String hash = "0xa1a3f100f08d6eb1c723e682a95ef0625ee52dd0e01bd50b2cd247813e91d398";
        ConfigHelper configHelper = new ConfigHelper();
        ChainConfig config = configHelper.getConfig("1", "uniswap");
        System.out.println(decodeInputData(config, logs, interTx, hash));
    }
}

